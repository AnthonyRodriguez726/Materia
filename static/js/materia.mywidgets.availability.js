(function(){Namespace("Materia.MyWidgets").Availability=function(){var init,popup,_changeAvailability,_checkAttempts,_dateFormatter,_inst,_parseSubmittedInfo,_setSlider,_submittedAttempts,_times;return _inst={},_submittedAttempts=null,_times={},_parseSubmittedInfo=function(){var errors,reason,success,type;return success=!0,errors={type:[],reason:[]},$(".error").removeClass("error"),$(".toFrom li input.availability:checked").each(function(){var ampm,date,dateObj,datesParent,fullDate,hourBounds,hourLength,hourMinute,idCheck,minuteBounds,minuteLength,startOrEnd,time,timeObj;if(idCheck=$(this).attr("id"),startOrEnd=idCheck.match("From")?"start":"end",datesParent=$(this).closest(".datePicker"),dateObj=datesParent.find("input.date"),timeObj=datesParent.find("input.time"),date=$(dateObj).val(),time=$(timeObj).val(),ampm=datesParent.find(".ampm.selected").text(),hourMinute=["",""],null!=time&&(hourMinute=time.split(":")),hourLength=""===hourMinute[0]?!0:hourMinute[0].length<3,null!=hourMinute[1]&&(minuteLength=""===hourMinute[1]?!0:hourMinute[1].length<3),hourBounds=Number(hourMinute[0])<13,minuteBounds=Number(hourMinute[1])<60,""===time&&(time="start"===startOrEnd?"6:00":"11:59",ampm="start"===startOrEnd?"am":"pm"),idCheck.match("anytime"))return _times[startOrEnd]=-1;if(""===date){if(dateObj.addClass("error"),success=!1,$.inArray("Date",errors.type)<0&&errors.type.push("Date"),$.inArray("missing",errors.reason)<0)return errors.reason.push("missing")}else{if(hourLength&&minuteLength&&hourBounds&&minuteBounds&&time.match(/[0-9]{1,2}:[0-9]{2}/))return fullDate=date+" "+time+ampm,_times[startOrEnd]=Date.parse(fullDate).getTime()/1e3;if($.inArray("Time",errors.type)<0&&errors.type.push("Time"),timeObj.addClass("error"),success=!1,""===time&&$.inArray("missing",errors.reason)<0)return errors.reason.push("missing");if($.inArray("invalid",errors.reason)<0)return errors.reason.push("invalid")}}),success?!0:(type=errors.type.length>1?""+errors.type[0]+"s and "+errors.type[1]+"s are ":""+errors.type[0]+" is ",reason=errors.reason.length>1?""+errors.reason[0]+"/"+errors.reason[1]:errors.reason[0],$(".availabilityError").remove(),$(".attemptsPopup").before('<p class="availabilityError">'+type+reason+"</p>"),!1)},_dateFormatter=function(range){var ampm,date,endInfo,startInfo,timeSet;return date=[],date.start="",date.end="",startInfo=null,endInfo=null,timeSet=$("#avaliability").text().match(/[0-9]+\/[0-9]+\/[0-9]+ at [0-9]+:[0-9]+(am|pm)/g),null!=timeSet&&(timeSet[0]&&"to"!==range&&(startInfo=timeSet[0].split(" at ")),timeSet[1]?endInfo=timeSet[1].split(" at "):"to"===range&&(endInfo=timeSet[0].split(" at "))),startInfo&&(date.start=startInfo[0],$(".date.from").val(startInfo[0]),ampm=startInfo[1].match(/(am|pm)/)[1],$("#startTime").val(startInfo[1].slice(0,-2)),$(".start.ampm."+ampm).trigger("click")),endInfo&&(date.end=endInfo[0],$(".date.to").val(endInfo[0]),ampm=endInfo[1].match(/(am|pm)/)[1],$("#endTime").val(endInfo[1].slice(0,-2)),$(".end.ampm."+ampm).trigger("click")),$(".time").blur(function(){var val;return val=$(this).val(),!val.match(":")&&13>val&&""!==val?$(this).val(""+val+":00"):void 0}),date},_checkAttempts=function(number){var num;return num=Math.floor(number/1e3),$(".attemptHolder #value_"+num).length>0?($(".attemptHolder li.selected").removeClass("selected"),$(".attemptHolder #value_"+num).addClass("selected")):$("#value_"+(num+2)).length>0&&num+2>4?($(".attemptHolder li.selected").removeClass("selected"),$(".attemptHolder #value_"+(num+2)).addClass("selected")):$("#value_"+(num-2)).length>0&&num-2>4?($(".attemptHolder li.selected").removeClass("selected"),$(".attemptHolder #value_"+(num-2)).addClass("selected")):void 0},_setSlider=function(){var attemptsValue,idNum,realNum;idNum=$(".attemptHolder li.selected").attr("id").split("_")[1],attemptsValue=$(".selected").html(),realNum=1e3*parseInt(idNum,10),$(".selector").slider("value",realNum),$("#valueHolder").html(attemptsValue),_submittedAttempts=parseInt(idNum),25===_submittedAttempts&&(_submittedAttempts=-1)},_changeAvailability=function(callback){return Materia.Widget.saveWidget({inst_id:_inst.id,open_at:_times.start,close_at:_times.end,attempts:_submittedAttempts},function(){},Materia.MyWidgets.SelectedWidget.populateAvailability(_times.start,_times.end),Materia.MyWidgets.SelectedWidget.populateAttempts(parseInt(_submittedAttempts,10)),callback())},init=function(){},popup=function(){var gameId;return gameId=$(".gameSelected").attr("id").split("_")[1],Materia.WidgetInstance.get(gameId,function(inst){var date,range;switch(_inst=inst,$(".selector").slider({value:_inst.attempts<0?25e3:1e3*_inst.attempts,min:1e3,max:25e3,create:function(){var ui;return ui={},ui.value=_inst.attempts<0?25e3:1e3*_inst.attempts,_checkAttempts(ui.value),_setSlider()},slide:function(event,ui){return _checkAttempts(ui.value)},stop:function(){return _setSlider()}}),!1){case!(_inst.close_at<0&&_inst.open_at<0):range="none";break;case!(_inst.open_at<0&&_inst.close_at>0):range="to";break;case!(_inst.open_at>0&&_inst.close_at<0):range="from";break;default:range="toFrom"}switch($(".start.ampm").add($(".end.ampm")).click(function(){var $this;return $this=$(this),$this.is(".pm")?($this.addClass("selected"),$this.parent().children(".am").removeClass("selected")):($this.addClass("selected"),$this.parent().children(".pm").removeClass("selected"))}),date=_dateFormatter(range),$(".date.from").datepicker({maxDate:date.end,onSelect:function(dateText){return $(".date.to").datepicker("option",{minDate:dateText})}}),$(".date.to").datepicker({minDate:date.start,onSelect:function(dateText){return $(".date.from").datepicker("option",{maxDate:dateText})}}),$(".date, .time").click(function(){return $(this).closest(".datePicker").find(".specify.availability").trigger("click")}),range){case"none":$("#anytimeFrom").trigger("click"),$("#anytimeTo").trigger("click");break;case"to":$("#anytimeFrom").trigger("click"),$("#specifyTo").trigger("click");break;case"from":$("#specifyFrom").trigger("click"),$("#anytimeTo").trigger("click");break;case"toFrom":$("#specifyFrom").trigger("click"),$("#specifyTo").trigger("click")}return $(".time").keypress(function(e){return Materia.Validate.Textfield.timeOnly(e)?void 0:e.preventDefault()}),$(window).keyup(function(e){return 27===e.keyCode?($(window).unbind("keyup"),$.jqmodal("close")):void 0}),$(".attemptHolder li").click(function(){var clickedAmount;return clickedAmount=1e3*$(this).attr("id").split("_")[1],$(".selector").slider("value",clickedAmount),_checkAttempts(clickedAmount),_setSlider()}),$(".save").click(function(e){return e.preventDefault(),_parseSubmittedInfo()&&_changeAvailability(function(){return $.jqmodal("close")}),!1})})},{init:init,popup:popup}}()}).call(this);