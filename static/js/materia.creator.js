(function(){Namespace("Materia").Creator=function(){var init,onMediaImportComplete,onQuestionImportComplete,_alert,_cancelPreview,_cancelPublish,_creator,_embed,_embedDoneDfd,_embedFlash,_embedHTML,_embedTarget,_enableQuestionImport,_enableReturnLink,_fadeSaveButton,_getMyWidgetsUrl,_getQset,_getWidgetInfo,_getWidgetInstance,_heartbeat,_importerPopup,_initCreator,_inst_id,_instance,_keepQSet,_onCreatorReady,_onInitFail,_onPreviewPopupBlocked,_onPublishPressed,_onSaveCanceled,_requestSave,_resizeCreator,_save,_saveMode,_sendToCreator,_setHeight,_showButtons,_showMediaImporter,_showQuestionImporter,_startHeartBeat,_stopHeartBeat,_type,_widgetType,_widget_id,_widget_info;return _creator=null,_embedDoneDfd=null,_embedTarget=null,_heartbeat=null,_importerPopup=null,_inst_id=null,_instance=null,_keepQSet=null,_saveMode=!1,_type=null,_widget_id=null,_widget_info=null,_widgetType=null,_onInitFail=function(msg){return _stopHeartBeat(),"flash player required."!==msg.toLowerCase()?alert("Failure: "+msg):void 0},_startHeartBeat=function(){var dfd;return dfd=$.Deferred().resolve(),_heartbeat=setInterval(function(){return Materia.Coms.Json.send("session_valid",[null,!1],function(data){return data===!1?(alert("You have been logged out due to inactivity.\n\nPlease login again."),window.location.reload()):void 0})},3e4),dfd.promise()},_stopHeartBeat=function(){return clearInterval(_heartbeat)},_getWidgetInfo=function(){var dfd;return dfd=$.Deferred(),Materia.Coms.Json.send("widgets_get",[[_widget_id]],function(widgets){return _widget_info=widgets[0],dfd.resolve()}),dfd.promise()},_getWidgetInstance=function(){var dfd;return dfd=$.Deferred(),Materia.Coms.Json.send("widget_instances_get",[[_inst_id]],function(widgetInstances){return _instance=widgetInstances[0],_widget_info=_instance.widget,dfd.resolve()}),dfd.promise()},_enableQuestionImport=function(){return $("#importLink").on("click",_showQuestionImporter)},_getQset=function(){var dfd;return dfd=$.Deferred(),Materia.Coms.Json.send("question_set_get",[_inst_id],function(data){return _keepQSet=data,dfd.resolve()}),dfd.promise()},_initCreator=function(){var dfd;return dfd=$.Deferred().resolve(),null!=_inst_id?_sendToCreator("initExistingWidget",[_instance.name,_instance.widget,_keepQSet.data,_keepQSet.version,BASE_URL]):_sendToCreator("initNewWidget",[_widget_info,BASE_URL]),dfd.promise()},_sendToCreator=function(type,args){switch(_widgetType){case".swf":return _creator[type].apply(_creator,args);case".html":return _creator.contentWindow.postMessage(JSON.stringify({type:type,data:args}),STATIC_URL)}},_requestSave=function(mode){switch(_cancelPublish(null,!0),_cancelPreview(null,!0),_saveMode=mode){case"publish":$("#previewBtnTxt").html("Saving...");break;case"save":$("#saveBtnTxt").html("Saving...")}return _sendToCreator("onRequestSave",[mode])},_fadeSaveButton=function($button,label,finalLabel){return $button.fadeOut(function(){return $button.html(label),$button.fadeIn(function(){return window.setTimeout(function(){return $button.fadeOut(function(){return $button.html(finalLabel),$button.fadeIn()})},5e3)})})},_showQuestionImporter=function(){var types;return null!=_importerPopup&&_importerPopup.close(),types=_widget_info.meta_data.supported_data,_importerPopup=window.open("/questions/import/?type="+encodeURIComponent(types.join()),"question_import","width=600,height=600")},_getMyWidgetsUrl=function(inst_id){return""+BASE_URL+"my-widgets#"+inst_id},_embed=function(){var creatorPath,dfd;switch(dfd=$.Deferred(),_widgetType=_widget_info.creator.slice(_widget_info.creator.lastIndexOf(".")),creatorPath="http"===_widget_info.creator.substring(0,4)?_widget_info.creator:WIDGET_URL+_widget_info.dir+_widget_info.creator,_type=creatorPath.split(".").pop()){case"html":_embedHTML(creatorPath,dfd);break;case"swf":_embedFlash(creatorPath,_widget_info.flash_version,dfd)}return $(window).bind("beforeunload",function(){return null!=_importerPopup?_importerPopup.close():void 0}),dfd.promise()},_embedHTML=function(htmlPath,dfd){var $iframe,_onPostMessage;return _embedDoneDfd=dfd,$iframe=$('<iframe src="'+htmlPath+'" id="container" class="html"></iframe>'),$("#container").replaceWith($iframe),_onPostMessage=function(e){var msg,origin;if(origin=""+e.origin+"/",origin!==STATIC_URL&&origin!==BASE_URL)return alert("Error, cross domain restricted for "+origin);switch(msg=JSON.parse(e.data),msg.type){case"start":return _onCreatorReady();case"save":return _save(msg.data[0],msg.data[1],msg.data[2]);case"cancelSave":return _onSaveCanceled(msg.data[0]);case"showMediaImporter":return _showMediaImporter();case"setHeight":return _setHeight(msg.data[0]);case"alert":return _alert(msg.data);default:return alert("Unknown message from creator: "+msg.type)}},"undefined"!=typeof addEventListener&&null!==addEventListener?addEventListener("message",_onPostMessage,!1):"undefined"!=typeof attachEvent&&null!==attachEvent?attachEvent("onmessage",_onPostMessage):void 0},_embedFlash=function(path,version,dfd){var attributes,expressSwf,flashvars,height,params,width;return window.__materia_flash_onCreatorReady=_onCreatorReady,window.__materia_flash_importMedia=_showMediaImporter,window.__materia_flash_save=_save,window.__materia_flash_cancelSave=_onSaveCanceled,_embedDoneDfd=dfd,swfobject.hasFlashPlayerVersion("1")!==!1?(flashvars={URL_WEB:BASE_URL,URL_GET_ASSET:""+BASE_URL+"media/",widget_id:_widget_id,inst_id:_inst_id},params={menu:"false",allowFullScreen:"true",AllowScriptAccess:"always"},attributes={id:_embedTarget},expressSwf=""+BASE_URL+"assets/flash/expressInstall.swf",width="100%",height="100%","undefined"!=typeof ie8Browser&&null!==ie8Browser&&(width="99.7%",height="99.7%"),swfobject.embedSWF(path,_embedTarget,width,height,version,expressSwf,flashvars,params,attributes)):0!==$("#no_flash").length?$("#no_flash").css({display:"block"}):void 0},_resizeCreator=function(){return $(".center").height($(window).height()-145)},_showButtons=function(){var dfd;return dfd=$.Deferred().resolve(),_instance&&!_instance.is_draft&&($("#creatorPublishBtn").html("Update"),$("#creatorPreviewBtn").hide(),$("#creatorSaveBtn").hide(),$("#action-bar .dot").hide()),_enableReturnLink(),_enableQuestionImport(),$("#action-bar").css("visibility","visible"),dfd.promise()},_enableReturnLink=function(){return null!=_inst_id?$("#returnLink").html("&larr; Return to my widgets").attr("href",_getMyWidgetsUrl(_inst_id)):$("#returnLink").html("&larr; Return to widget catalog").attr("href",BASE_URL+"widgets")},_onPublishPressed=function(){var $dialog,dialogTemplate;return _cancelPreview(null,!0),dialogTemplate=null==_inst_id||null==_instance||_instance.is_draft?_.template($("#t-publish-dialog").html()):_.template($("#t-update-dialog").html()),$dialog=$(dialogTemplate()),$dialog.hide(),$dialog.find(".cancel_button").on("click",_cancelPublish),$dialog.find(".action_button").on("click",function(){return _requestSave("publish")}),$("#creatorPublishBtn").unbind("click"),$(".page").prepend($dialog),$(".publish").slideDown("slow")},_cancelPublish=function(e,instant){return null==instant&&(instant=!1),null!=e&&e.preventDefault(),$(".publish .action_button, .publish .cancel_button").unbind("click"),$(".publish").slideUp(instant?"fast":"slow",function(){return $(".publish").remove(),$("#creatorPublishBtn").on("click",_onPublishPressed)})},_onPreviewPopupBlocked=function(url){var $dialog,dialogTemplate;return dialogTemplate=_.template($("#t-popup-blocked").html()),$dialog=$(dialogTemplate()).hide(),$dialog.find(".cancel_button").on("click",_cancelPreview),$dialog.find(".action_button").attr("href",url).attr("target","_blank").on("click",function(){return _cancelPreview()}),$(".page").prepend($dialog),$(".preview").slideDown("slow")},_cancelPreview=function(e,instant){return null==instant&&(instant=!1),null!=e&&e.preventDefault(),$(".preview .action_button, .preview .cancel_button").unbind("click"),$(".preview").slideUp(instant?"fast":"slow",function(){return $(".preview").remove()})},_onCreatorReady=function(){return _creator=$("#container").get(0),$(window).resize(_resizeCreator),_resizeCreator(),$("#creatorPublishBtn").on("click",_onPublishPressed),$("#creatorPreviewBtn").on("click",function(){return _requestSave("preview")}),$("#creatorSaveBtn").on("click",function(){return _requestSave("save")}),_embedDoneDfd.resolve()},_showMediaImporter=function(){return null!=_importerPopup&&_importerPopup.close(),_importerPopup=window.open("/media/import","question_import","width=675,height=600"),null},_save=function(instanceName,qset,version){return null==version&&(version=1),Materia.Coms.Json.send("widget_instance_save",[_widget_id,instanceName,{version:version,data:qset},"publish"!==_saveMode,_inst_id,null,null,null],function(inst){var popup,url;if(null!=inst)switch(0!==String(_inst_id).length&&(window.location.hash="#"+inst.id),_saveMode){case"preview":return url=""+BASE_URL+"preview/"+inst.id,popup=window.open(url),null!=popup?setTimeout(function(){return popup.innerHeight>0?void 0:_onPreviewPopupBlocked(url)},200):_onPreviewPopupBlocked(url);case"publish":return window.location=_getMyWidgetsUrl(inst.id);case"save":return _fadeSaveButton($("#saveBtnTxt"),"Saved!","Save Draft"),_sendToCreator("onSaveComplete",[inst.name,inst.widget,inst.qset.data,inst.qset.version]),_inst_id=inst.id,_instance=inst}})},_onSaveCanceled=function(msg){return _fadeSaveButton($("#saveBtnTxt"),"Can Not Save!","Save Draft"),msg?alert("Can not currently save. "+msg):void 0},_setHeight=function(h){return $("#container").height(h)},_alert=function(options){var alertWindow,b,buttons,msg,title,type,_i,_len;switch(title=options.title,msg=options.msg,type=options.type,alertWindow=$("<div>"),alertWindow.append("<h1>"+title+"</h1>"),alertWindow.append("<p>"+msg+"</p>"),buttons=[],type){case 1:buttons=["OK"];break;case 2:buttons=["OK","Cancel"];break;case 3:buttons=["Yes","No"]}for(_i=0,_len=buttons.length;_len>_i;_i++)b=buttons[_i],alertWindow.append('<button class="action_button">'+b+"</button>");return $.jqmodal.standalone({modal:!0,backgroundStyle:"light",className:"alert",html:alertWindow.html(),closingSelectors:["button"]})},init=function(container,widget_id,inst_id){return _widget_id=widget_id,_inst_id=inst_id,_embedTarget=container,window.location.hash&&(_inst_id=window.location.hash.substr(1)),null!=_inst_id?$.when(_getWidgetInstance()).pipe(_embed).pipe(_getQset).pipe(_initCreator).pipe(_showButtons).pipe(_startHeartBeat).fail(_onInitFail):$.when(_getWidgetInfo()).pipe(_embed).pipe(_initCreator).pipe(_showButtons).pipe(_startHeartBeat).fail(_onInitFail)},onQuestionImportComplete=function(questions){return questions=JSON.parse(questions),_sendToCreator("onQuestionImportComplete",[questions]),null!=_importerPopup?_importerPopup.close():void 0},onMediaImportComplete=function(media){var anArray,element,_i,_len;for(null!=_importerPopup&&_importerPopup.close(),anArray=[],_i=0,_len=media.length;_len>_i;_i++)element=media[_i],anArray.push(element);return _sendToCreator("onMediaImportComplete",[anArray])},{init:init,onQuestionImportComplete:onQuestionImportComplete,onMediaImportComplete:onMediaImportComplete}}()}).call(this);