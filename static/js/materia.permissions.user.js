(function(){Namespace("Materia.Permissions").User=function(){var ACCESS_VALUE_FULL,ACCESS_VALUE_VIEW_SCORES,DEMOTE_SELF_MSG,EXPIRE_SELF_MSG,REMOVE_SELF_MSG,SUPER_USER,createCollaboratorRow,disableRow,getDateForBeginningOfTomorrow,getExpirationDateString,init,modifyCollaboratorPermissions,modifyExpiration,removeCollaborator,repositionSearchWindow,search,searchMatchClick,showSelfDemotionWarning,stopSpin,updateAccessValueUI,updateExpirationLinkUI,updatePerms;return REMOVE_SELF_MSG="Are you sure you want to remove <strong>your</strong> access?",DEMOTE_SELF_MSG="Are you sure you want to limit <strong>your</strong> access?",EXPIRE_SELF_MSG="Are you sure you want to expire <strong>your</strong> access?",ACCESS_VALUE_FULL=30,SUPER_USER=90,ACCESS_VALUE_VIEW_SCORES=0,init=function(){},showSelfDemotionWarning=function($parent,message,callback){var $confirm,$pointingTo,p;return $confirm=$('<div class="demote_dialogue"><div class="arrow"></div><span class="warning">'+message+'</span><a class="button no_button" href="#">No</a><a class="button action_button red yes_button" href="#">Yes</a></div>'),$pointingTo=$parent.find("img"),p=$pointingTo.offset(),$parent.append($confirm),p.left+=$pointingTo.outerWidth()+11,p.top+=($pointingTo.outerHeight()-$confirm.outerHeight())/2,$confirm.css("z-index","10000").css("position","absolute").offset(p),$confirm.find(".button").click(function(event){return event.preventDefault(),$(".demote_dialogue").remove()}),$confirm.find(".no_button").click(function(event){return event.preventDefault(),callback(!1)}),$confirm.find(".action_button").click(function(event){return event.preventDefault(),callback(!0)})},getDateForBeginningOfTomorrow=function(){var d;return d=new Date,d.setDate(d.getDate()+1),new Date(d.getFullYear(),d.getMonth(),d.getDate())},getExpirationDateString=function(timestamp){return timestamp=parseInt(timestamp,10),isNaN(timestamp)||0===timestamp?"Never":$.datepicker.formatDate("mm/dd/yy",new Date(1e3*timestamp))},createCollaboratorRow=function(collaborator,newAccess,currentAccess,expire){var $expirationButton,$row,defaultAvatarLocation,initialExpirationTimestamp;return defaultAvatarLocation="?d="+BASE_URL+"assets/img/default-avatar.jpg",$row=$("#permdump").clone(),initialExpirationTimestamp=expire,$expirationButton=$row.find(".exp-date"),$row.data("expirationDate",expire).data("user-id",collaborator.id).data("current-user",collaborator.isCurrentUser).data("access",newAccess),$row.attr("id","user-"+collaborator.id),$row.find(".avatar").attr("src","https://secure.gravatar.com/avatar/"+hex_md5(collaborator.email)+defaultAvatarLocation),$row.find(".name").html(collaborator.first+" "+collaborator.last+(collaborator.isCurrentUser?"<span>(You)</span>":"")),$row.find(".remove").on("click",function(event){return event.preventDefault(),removeCollaborator(collaborator,$row)}),$row.find(".perm").on("change",function(event){var newAccessValue;return newAccessValue=parseInt($(this).val(),10),event.preventDefault(),modifyCollaboratorPermissions(collaborator,newAccessValue,$row)}),updateAccessValueUI($row,newAccess),$expirationButton.datepicker({minDate:getDateForBeginningOfTomorrow(),onSelect:function(){return modifyExpiration(collaborator,$(this).datepicker("getDate").getTime()/1e3,$row)}}),updateExpirationLinkUI($row,expire),$expirationButton.focusout(function(event){var isValidDate;return isValidDate=function(date){var exception,isDate,parsed_date;if(date.length<=0)return!1;isDate=!1;try{parsed_date=$.datepicker.parseDate("mm/dd/yy",date),isDate=Date.now()<parsed_date}catch(_error){exception=_error}return isDate},"Never"===$(this).val()||isValidDate($(this).val())?void 0:(alert("Please enter a valid date."),$(this).val("Never"),event.preventDefault())}),$row.find(".remove-expiration").on("click",function(event){return event.preventDefault(),modifyExpiration(collaborator,null,$row)}),currentAccess!==ACCESS_VALUE_FULL&&currentAccess!==SUPER_USER&&disableRow(collaborator,$row),$("#popup").find(".access_list").append($row)},disableRow=function(collaborator,$row){return $row.find("select").prop("disabled",!0),$row.find(".exp-date").addClass("disabled").datepicker("destroy"),$row.find(".remove-expiration").hide(),collaborator.isCurrentUser?void 0:$row.find(".remove").css("visibility","hidden")},updateExpirationLinkUI=function($row,expiration_date){return $row.find(".exp-date").val(getExpirationDateString(expiration_date)),null!=expiration_date?$row.find(".remove-expiration").show():$row.find(".remove-expiration").hide()},removeCollaborator=function(collaborator,$row){var removalFunction;return removalFunction=function(confirmed){var index;return confirmed?(index=$.inArray(collaborator.id,$("#popup.share").data("usersToAdd")),-1===index?$("#popup.share").data("usersToRemove").push(collaborator.id):$("#popup.share").data("usersToAdd").splice(index,1),$row.fadeOut("fast",function(){return $(this).remove()})):void 0},collaborator.isCurrentUser?0===$row.find(".demote_dialogue").length?showSelfDemotionWarning($row,REMOVE_SELF_MSG,removalFunction):void 0:removalFunction(!0)},modifyCollaboratorPermissions=function(collaborator,newAccessValue,$row){var modifyFunction;return modifyFunction=function(accessValue){return $row.data("access",accessValue),updateAccessValueUI($row,accessValue)},collaborator.isCurrentUser&&newAccessValue===ACCESS_VALUE_VIEW_SCORES?showSelfDemotionWarning($row,DEMOTE_SELF_MSG,function(confirmed){return modifyFunction(null!=confirmed?confirmed:{newAccessValue:ACCESS_VALUE_FULL})}):modifyFunction(newAccessValue)},updateAccessValueUI=function($row,accessValue){return accessValue=parseInt(accessValue,10),$row.find('select option[value="'+accessValue+'"]').attr("selected","selected")},modifyExpiration=function(collaborator,newExpirationTimestamp,$row){var modifyFunction;return modifyFunction=function(expirationTimestamp){return $row.data("expirationDate",expirationTimestamp),updateExpirationLinkUI($row,expirationTimestamp)},!collaborator.isCurrentUser||null===newExpirationTimestamp||null!==$row.data("expirationDate")&&$row.data("expirationDate")?modifyFunction(newExpirationTimestamp):showSelfDemotionWarning($row,EXPIRE_SELF_MSG,function(confirmed){return modifyFunction(null!=confirmed?confirmed:{newExpirationTimestamp:null})})},search=function(nameOrFragment){var inputArray;return Materia.Set.Throbber.startSpin(".search_list",{withDelay:!1,withBackground:!1,absolute:!1}),inputArray=nameOrFragment.split(","),nameOrFragment=inputArray[inputArray.length-1],nameOrFragment.length<1?(stopSpin(),void 0):Materia.Coms.Json.send("users_search",[nameOrFragment],function(matches){var gravatar,match,matchesHolder,noMatchMsg,searchList,targetIndex,user,_i,_len;if(null===matches||"undefined"==typeof matches||matches.length<1)return noMatchMsg="The person you're searching for may need to log in to create an account.",$("#popup .search_list").html("<p class='no_match_message'>No matches found.</p>"),$("#popup .search_list .no_match_message").after("<p class='no_match_reason'>"+noMatchMsg+"</p>"),stopSpin(),void 0;for(matchesHolder=$("<div></div>"),_i=0,_len=matches.length;_len>_i;_i++)user=matches[_i],match=$('<div><img class="user_match_avatar" src=""></img><p class="user_match_name"></p></div>'),$(match).attr("id","match_user_"+user.id),$(match).addClass("search_match"),$(match).attr("tabindex",0),gravatar="https://secure.gravatar.com/avatar/"+hex_md5(user.email)+"?d="+BASE_URL+"assets/img/default-avatar.jpg",$(match).find(".user_match_avatar").attr("src",gravatar),$(match).find(".user_match_email").attr("value",user.email),$(match).find(".user_match_name").html(user.first+" "+user.last),$.data(match[0],"info",{id:user.id,first:user.first,last:user.last,email:user.email}),matchesHolder.append(match),1===matches.length&&$(match).css("background-color","#7fc9f3");return $("#popup .search_list").empty(),matchesHolder.children().each(function(){var $new_perm;return $new_perm=this,$("#popup .search_list").append($new_perm)}),$("#popup").tablock("reset"),$(".search_match").click(searchMatchClick),targetIndex=-1,searchList=$("#popup .search_list").children(),$("#popup.share").keyup(function(e){if(e.which>=37&&e.which<=40){switch(e.preventDefault(),targetIndex=$.inArray(searchList[targetIndex],searchList),e.which){case 37:if(!(targetIndex>-1))return stopSpin(),void 0;targetIndex--;break;case 38:if(2>targetIndex)return $("#popup .user_add").focus(),targetIndex=-1,stopSpin(),void 0;targetIndex-=2;break;case 39:if(!(targetIndex>-1))return stopSpin(),void 0;targetIndex++;break;case 40:-1===targetIndex?targetIndex=0:targetIndex+=2}return $(searchList[targetIndex]).focus()}if(13===e.which){if(1===searchList.length)return $(searchList[0]).click();if(searchList.length>1)return $(searchList[targetIndex]).click()}}),stopSpin()})},stopSpin=function(){return Materia.Set.Throbber.stopSpin(".search_list")},searchMatchClick=function(){var clickedMatch,info,newDiv,popup_data,selectedUsers,user,_i,_len;for(clickedMatch=$(this)[0],info=$.data(clickedMatch,"info"),selectedUsers=$("#popup #access .access_list .user_perm"),popup_data=$("#popup.share").data(),_i=0,_len=selectedUsers.length;_len>_i;_i++)if(user=selectedUsers[_i],user.id.split("-")[1]===info.id)return alert("This user already has access to this widget."),$("#popup .user_add").val(""),$("#popup .search_list").empty().slideUp(50),void 0;return newDiv=$('<input class="share_user_to_add" type="button" value="'+info.first+" "+info.last+'"/>'),$(newDiv).click(function(){var lastHeight;return lastHeight=$("#popup  #input_area").height(),$(this).remove(),$("#popup  #input_area").height()!==lastHeight?Permissions.User.repositionSearchWindow():void 0}),popup_data.usersToAdd.push(info.id),$(".search_match").remove(),$(".user_add").val(""),$("#popup .search_list").hide(),$("#popup .adding_shadow").hide(),Materia.Permissions.Widget.buildPermsList()},repositionSearchWindow=function(){var addPos,addPosHeight;return addPos=$("#popup .user_add").offset(),addPosHeight=$("#popup .user_add").height(),$("#popup .search_list").offset({left:addPos.left,top:addPos.top+addPosHeight})},updatePerms=function(permObj,onSuccessCallback){var cleanID;return cleanID=$(".gameSelected").attr("id").split("_")[1],$("#popup.share").addClass("loading"),Materia.Coms.Json.send("permissions_set",[0,cleanID,permObj],function(returnData){return"undefined"!=typeof returnData.type&&"warn"===returnData.type?(alert(returnData.msg),$("#popup.share").removeClass("loading")):($("#popup.share .cancel_button").click(),void 0!==onSuccessCallback?onSuccessCallback():void 0)})},{init:init,createCollaboratorRow:createCollaboratorRow,search:search,repositionSearchWindow:repositionSearchWindow,updatePerms:updatePerms}}()}).call(this);