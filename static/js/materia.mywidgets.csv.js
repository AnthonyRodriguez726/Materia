// Generated by CoffeeScript 1.6.3
(function() {
  Namespace('Materia.MyWidgets').Csv = (function() {
    var AddRemoveSemesterToggle, buildPopup, checkAllToggle, chosenSemesters, enableDownload, getScores, init, inst_id, semesterArray, showOptions, updateScoreHeader;
    semesterArray = ['Spring', 'Summer', 'Fall'];
    inst_id = null;
    chosenSemesters = null;
    init = function(gateway) {};
    buildPopup = function() {
      $('.csv_popup').hide();
      getScores($('.gameSelected').attr('id').split('_')[1]);
      $('.download_options').css({
        left: $('.csv_popup').outerWidth(true)
      });
      $('.show_options').click(function(e) {
        e.preventDefault();
        return showOptions();
      });
      $('#checkall').click(function() {
        return checkAllToggle(this);
      });
      return $('.csv_popup').fadeIn();
    };
    getScores = function(gameId) {
      var $change, $dontChange;
      inst_id = gameId;
      $dontChange = $('.download_options ul li:first-child');
      $change = $dontChange.next();
      return Materia.Coms.Json.send('score_summary_get', [inst_id], function(summary) {
        var $cloned, id, label, s, _i, _len;
        for (_i = 0, _len = summary.length; _i < _len; _i++) {
          s = summary[_i];
          $cloned = $change.clone();
          label = s.year + ' ' + s.term;
          id = s.year + '_' + s.term;
          $cloned.children('input').attr('value', label).attr('id', id).end().children('label').html(label).attr('for', id);
          $change.before($cloned);
          $cloned.children('input').click(function() {
            return AddRemoveSemesterToggle(this);
          });
        }
        $dontChange.next().children('input').trigger('click');
        $change.remove();
        if ($('.semester').length === 1) {
          $('.semester').attr('disabled', 'disabled');
          $dontChange.remove();
        }
        return AddRemoveSemesterToggle();
      });
    };
    checkAllToggle = function(element) {
      var $element;
      $element = $(element);
      if ($element.is(':checked')) {
        $element.next().html(' - Uncheck all');
        return $('.semester:not(:checked)').each(function() {
          $(this).trigger('click');
          return AddRemoveSemesterToggle(this);
        });
      } else {
        $('.semester:checked').each(function() {
          $(this).trigger('click');
          return AddRemoveSemesterToggle(this);
        });
        return $element.next().html(' - Check all');
      }
    };
    AddRemoveSemesterToggle = function(element) {
      chosenSemesters = [];
      $.each($('input.semester:checked'), function() {
        return chosenSemesters.push($(this).val());
      });
      updateScoreHeader();
      return enableDownload(chosenSemesters.length > 0);
    };
    updateScoreHeader = function() {
      var h4text, lastItem, semester, _i, _len;
      h4text = [];
      for (_i = 0, _len = chosenSemesters.length; _i < _len; _i++) {
        semester = chosenSemesters[_i];
        h4text.push(semester);
      }
      h4text.sort(function(a, b) {
        var asplit, bsplit;
        asplit = a.split(' ');
        bsplit = b.split(' ');
        if (asplit[0] - bsplit[0] === 0) {
          return semesterArray.indexOf(asplit[1]) - semesterArray.indexOf(bsplit[1]);
        } else {
          return asplit[0] - bsplit[0];
        }
      });
      h4text.reverse();
      switch (false) {
        case !(h4text.length > 2):
          lastItem = h4text.pop();
          h4text = h4text.join(', ');
          h4text += " and " + lastItem;
          break;
        case h4text.length !== 2:
          h4text = h4text.join(', ');
          break;
        case !(h4text.length > 0):
          h4text = h4text[0];
          break;
        default:
          h4text = "(None Selected)";
      }
      return $('.download_wrapper h4').html(h4text);
    };
    showOptions = function() {
      $('.download_options').show('slide', {
        direction: 'left'
      });
      return $('.show_options').removeClass('show_options').addClass('hide_options').text('Hide').unbind('click').click(function(e) {
        e.preventDefault();
        $('.download_options').hide('slide', {
          direction: 'left'
        });
        return $('.hide_options').removeClass('hide_options').addClass('show_options').text('Semesters...').unbind('click').click(function(e) {
          e.preventDefault();
          return showOptions();
        });
      });
    };
    enableDownload = function(enable) {
      if (enable) {
        return $('#popup.csv_popup p.download a').removeClass('disabled').attr('href', "/scores/csv/" + inst_id + "/" + (chosenSemesters.join(',').replace(/\s/g, '-'))).click(function() {
          return window.location = $(this).attr('href');
        });
      } else {
        return $('#popup.csv_popup p.download a').addClass('disabled').attr('href', '#');
      }
    };
    return {
      init: init,
      buildPopup: buildPopup
    };
  })();

}).call(this);
