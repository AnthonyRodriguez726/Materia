(function(){Namespace("Materia").Scores=function(){var addCircleToDetailTable,attempt_dates,attempts,barPlot,currentAttempt,details,displayAttempts,displayDetails,displayScoreData,displayWidgetInstance,getAttemptNumberFromHash,getInstanceScores,getScoreDetails,getWidgetInstance,init,isEmbedded,isPreview,sendPostMessage,templates,toggleClassRankGraph,updateHtmlTemplate,widgetInstance,_graphData,_inst_id,_setupEvents;return attempts=null,attempt_dates=null,details=null,currentAttempt=null,templates={},widgetInstance=null,isPreview=!1,isEmbedded=!1,barPlot=null,_graphData=[],_inst_id=null,_setupEvents=!1,init=function(){var play_id,widget_id;return isPreview=/\/preview\//i.test(document.URL),isEmbedded=-1!==window.location.href.toLowerCase().indexOf("/scores/embed/"),play_id=window.location.hash.split("play-")[1],widget_id=document.URL.match(/^[\.\w\/:]+\/([a-z0-9]+)/i)[1],attempts=[],attempt_dates=[],details=[],Materia.Scores.displayScoreData(widget_id,play_id),$(window).bind("hashchange",getScoreDetails),templates.overview=$(".overview").clone(),templates.details=$(".details").clone(),templates.title=$("article.container header > h1").clone(),isPreview||isEmbedded?void 0:($("#class-rank-button").show(),$("#class-rank-button").on("click",toggleClassRankGraph))},displayScoreData=function(inst_id,play_id){return $.when(getWidgetInstance(inst_id),getInstanceScores(inst_id)).done(function(){return displayAttempts(play_id),displayWidgetInstance()}).fail(function(){})},getWidgetInstance=function(inst_id){var dfd;return _inst_id=inst_id,dfd=$.Deferred(),Materia.Coms.Json.send("widget_instances_get",[[inst_id]],function(widgetInstances){return widgetInstances.length<1&&dfd.reject("Unable to retrieve widget info"),widgetInstance=widgetInstances[0],dfd.resolve()}),dfd.promise()},getInstanceScores=function(inst_id){var dfd;return dfd=$.Deferred(),isPreview?(attempts=[{id:-1,created_at:0,percent:0}],dfd.resolve()):Materia.Coms.Json.send("widget_instance_scores_get",[inst_id],function(scores){var $error,attemptScore,_i,_len;for((null===scores||scores.length<1)&&($("article.container").remove(),$error=$($("#t-restricted").html()),$error.find(".page").css("width","auto"),$("body").append($error),$error.show(),dfd.reject("No scores for this widget")),_i=0,_len=scores.length;_len>_i;_i++)attemptScore=scores[_i],attemptScore.roundedPercent=String(parseFloat(attemptScore.percent).toFixed(2));return attempts=scores,dfd.resolve()}),dfd.promise()},getScoreDetails=function(){var hash,play_id,prefix,_name;if(isPreview)return currentAttempt=1,Materia.Coms.Json.send("widget_instance_play_scores_get",[null,widgetInstance.id],displayDetails);if(hash=getAttemptNumberFromHash(),currentAttempt!==hash)return currentAttempt=hash,play_id=attempts[attempts.length-currentAttempt].id,isEmbedded===!0&&(prefix="/scores/",$("#visit-materia").attr("href",prefix+widgetInstance.id+"#attempt-"+currentAttempt)),("function"==typeof details[_name=attempts.length-currentAttempt]?details[_name](displayDetails(details[attempts.length-currentAttempt])):0)?void 0:Materia.Coms.Json.send("widget_instance_play_scores_get",[play_id],displayDetails)},displayWidgetInstance=function(){var hidePlayAgain,lengthRange,overview_data,paddingSize,prefix,textSize;switch(hidePlayAgain=!1,overview_data={title:widgetInstance.name,attempts:attempts,dates:attempt_dates},widgetInstance.attempts<=0||widgetInstance.attempts>0&&attempts.length<widgetInstance.attempts||isPreview?(prefix=isEmbedded?"/embed/":isPreview?"/preview/":"/play/",overview_data.href=prefix+widgetInstance.id+"/"+widgetInstance.clean_name,"undefined"!=typeof __LTI_TOKEN&&null!==__LTI_TOKEN&&(overview_data.href+="?ltitoken="+__LTI_TOKEN),overview_data.play_again=isPreview?"Preview Again":"Play Again"):hidePlayAgain=!0,updateHtmlTemplate(overview_data,"header"),lengthRange=Math.floor(widgetInstance.name.length/10),textSize=parseInt($("article.container header > h1").css("font-size")),paddingSize=parseInt($("article.container header > h1").css("padding-top")),lengthRange){case 0:case 1:case 2:textSize-=4,paddingSize+=4;break;case 3:textSize-=8,paddingSize+=8;break;default:textSize-=12,paddingSize+=12}return $("article.container header > h1").css({"font-size":textSize,"padding-top":paddingSize}),hidePlayAgain?$("#play-again").hide():void 0},displayAttempts=function(play_id){var d,i,matchedAttempt,_i,_ref;if(isPreview)return $("header").addClass("preview"),currentAttempt=1,getScoreDetails();if(attempts instanceof Array&&attempts.length>0){for(matchedAttempt=!1,i=_i=0,_ref=attempts.length-1;_ref>=0?_ref>=_i:_i>=_ref;i=_ref>=0?++_i:--_i)d=new Date(1e3*attempts[i].created_at),attempt_dates[i]=d.getMonth()+1+"/"+d.getDate()+"/"+d.getFullYear(),play_id===attempts[i].id&&(matchedAttempt=attempts.length-i);return isPreview?window.location.hash="#attempt-1":matchedAttempt!==!1?(window.location.hash="#attempt-"+matchedAttempt,getScoreDetails()):void 0===getAttemptNumberFromHash()?window.location.hash="#attempt-"+attempts.length:getScoreDetails()}},toggleClassRankGraph=function(){var text;return text=$("#class-rank-button").html(),$("#class-rank-button").html("Close Graph"===text?"Compare With Class":"Close Graph"),$("section.score-graph").slideToggle(),_graphData.length>0||isPreview?void 0:Materia.Coms.Json.send("score_summary_get",[widgetInstance.id],function(data){var bracket,d,jqOptions,n,_i,_j,_len,_len1;for(_graphData=[["0-9%",0],["10-19%",0],["20-29%",0],["30-39%",0],["40-49%",0],["50-59%",0],["60-69%",0],["70-79%",0],["80-89%",0],["90-100%",0]],_i=0,_len=data.length;_len>_i;_i++)for(d=data[_i],n=_j=0,_len1=_graphData.length;_len1>_j;n=++_j)bracket=_graphData[n],bracket[1]+=d.distribution[n];return jqOptions={animate:!0,animateReplot:!0,series:[{renderer:$.jqplot.BarRenderer,shadow:!1,color:"#1e91e1",rendererOptions:{animation:{speed:500}}}],seriesDefaults:{showMarker:!1,pointLabels:{show:!0,formatString:"%.0f",color:"#000"}},title:{text:"Compare Your Score With Everyone Else's",fontFamily:"Lato, Lucida Grande, Arial, sans"},axesDefaults:{tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{angle:0,fontSize:"8pt",color:"#000"}},axes:{xaxis:{renderer:$.jqplot.CategoryAxisRenderer,label:"Score Percent"},yaxis:{tickOptions:{formatString:"%.1f",angle:45},label:"Number of Scores",labelRenderer:$.jqplot.CanvasAxisLabelRenderer,color:"#000"}},cursor:{show:!1},grid:{shadow:!1}},barPlot=$.jqplot("graph",[_graphData],jqOptions)})},displayDetails=function(results){var $error,$previousAttempts,deets,score,tableItem,widget_data,_i,_j,_len,_len1,_ref,_ref1;if(!results)return $("article.container").remove(),widget_data={href:"/preview/"+widgetInstance.id+"/"+widgetInstance.clean_name},updateHtmlTemplate(widget_data,"expired"),$error=$("#t-expired"),$error.find(".page").css("width","auto"),$error.show(),void 0;for($("div.expired").remove(),details[attempts.length-currentAttempt]=results,deets=results[0],deets.overview.score=Math.round(deets.overview.score),_ref=deets.overview.table,_i=0,_len=_ref.length;_len>_i;_i++)tableItem=_ref[_i],tableItem.value.constructor===String&&(tableItem.value=parseFloat(tableItem.value)),tableItem.value=tableItem.value.toFixed(2);for(_ref1=deets.details[0].table,_j=0,_len1=_ref1.length;_len1>_j;_j++)tableItem=_ref1[_j],score=parseFloat(tableItem.score),0!==score&&100!==score&&(tableItem.score=score.toFixed(2));return updateHtmlTemplate(deets.overview,"overview"),isEmbedded||(updateHtmlTemplate(deets.details,"details"),addCircleToDetailTable(deets.details)),isPreview&&($(".overview hgroup h1").css("margin-top",10),$(".previous-attempts").hide()),$(".container").fadeIn(function(){return isPreview?$("#class-rank-button").remove():$("#class-rank-button").css("display","inline-block").on("click",toggleClassRankGraph)}),$("ul li.single_column").each(function(){var fixed_list_height;return fixed_list_height=$(this).children(":first").height(),$(this).height(fixed_list_height+40),$("ul li.single_column").children().each(function(){return 0!==$(this).index()?$(this).height(fixed_list_height):void 0})}),_setupEvents||(_setupEvents=!0,$previousAttempts=$(".previous-attempts"),isMobile.any()?($(".previous-attempts h1").on("click",function(){return $previousAttempts.toggleClass("open")}),$(".previous-attempts a").on("click",function(){return $previousAttempts.removeClass("open")})):($previousAttempts.on("mouseover",function(){return $previousAttempts.addClass("open")}),$previousAttempts.on("mouseout",function(){return $previousAttempts.removeClass("open")}))),sendPostMessage(deets.overview.score)},updateHtmlTemplate=function(data,template_name){var compiled,markup;return data.attempt_num=currentAttempt,markup=$("#score_"+template_name+"_template").html(),null!=markup?(compiled=_.template(markup,data,{variable:"data"}),$("."+template_name).html(compiled)):void 0},addCircleToDetailTable=function(detail){var canvas_id,greyMode,i,index,j,percent,table,_i,_ref,_results;for(_results=[],i=_i=0,_ref=detail.length-1;_ref>=0?_ref>=_i:_i>=_ref;i=_ref>=0?++_i:--_i)null!=detail[i]?_results.push(function(){var _j,_ref1,_results1;for(_results1=[],j=_j=0,_ref1=detail[i].table.length;_ref1>=0?_ref1>_j:_j>_ref1;j=_ref1>=0?++_j:--_j)switch(table=detail[i].table,greyMode=!1,index=j+1,canvas_id="question-"+(i+1)+"-"+index,percent=table[j].score/100,table[j].graphic){case"modifier":greyMode=0===table[j].score,_results1.push(Materia.Scores.Scoregraphics.drawModifierCircle(canvas_id,index,percent,greyMode));break;case"final":_results1.push(Materia.Scores.Scoregraphics.drawFinalScoreCircle(canvas_id,index,percent));break;case"score":greyMode=-1===table[j].score,_results1.push(Materia.Scores.Scoregraphics.drawScoreCircle(canvas_id,index,percent,greyMode));break;default:_results1.push(void 0)}return _results1}()):_results.push(void 0);return _results},sendPostMessage=function(score){return parent.postMessage&&JSON.stringify?parent.postMessage(JSON.stringify({type:"materiaScoreRecorded",widget:widgetInstance,score:score}),"*"):void 0},getAttemptNumberFromHash=function(){var hashStr;return hashStr=window.location.hash.split("-")[1],null==hashStr?attempts.length:hashStr},$(document).ready(function(){return Materia.Scores.init(API_LINK)}),{init:init,displayScoreData:displayScoreData}}()}).call(this);