// Generated by CoffeeScript 1.6.3
(function() {
  Namespace('Materia').Notification = (function() {
    var checkForOverflow, displayNotifications, getNotifications, init;
    init = function(gateway) {};
    getNotifications = function() {
      return Materia.Coms.Json.send('notifications_get', null, function(notifications) {
        if ($.isArray(notifications)) {
          displayNotifications(notifications);
        }
        return false;
      }, true);
    };
    checkForOverflow = function() {
      var holder;
      holder = $('#notices')[0];
      if (!$.data(holder, 'info')) {
        $.data(holder, 'info', {
          last: 0
        });
      }
      if (holder.clientWidth < holder.scrollWidth) {
        $(holder).css('padding-right', holder.scrollWidth - holder.clientWidth);
      } else if (holder.clientWidth !== $.data(holder, 'info').last) {
        $(holder).css('padding-right', 0);
      }
      return $.data(holder, 'info', {
        last: holder.clientWidth
      });
    };
    displayNotifications = function(notifications) {
      var $notice, $noticeSrc, areaHeight, note, num, _i, _len, _results;
      if (notifications.msg && notifications.msg.title === 'Invalid Login') {
        return;
      }
      areaHeight = $(window).height() - $('header').height();
      $('#notices').css('max-height', areaHeight);
      $('#notices').hide();
      num = notifications.length;
      if (num === 0) {
        return;
      }
      $('#notifications_link').show();
      $('#notifications_link').attr('data-notifications', num);
      $('#notifications_link').click(function() {
        var $object;
        if ($(this).hasClass('selected')) {
          return $('#notices').slideUp(function() {
            $('#notifications_link').removeClass('selected');
            if (typeof ie8Browser !== "undefined" && ie8Browser !== null) {
              $('#swfplaceholder').hide();
              return $('object').css('visibility', 'visible');
            }
          });
        } else {
          $object = $('object');
          if (typeof ie8Browser !== "undefined" && ie8Browser !== null) {
            if ($('#swfplaceholder').length > 0) {
              $('#swfplaceholder').show();
            }
            $object.css('visibility', 'hidden');
          }
          $('#notifications_link').addClass('selected');
          $('#notifications_link').show();
          $('#notices').children().fadeIn();
          return $('#notices').slideDown(function() {
            return checkForOverflow();
          });
        }
      });
      $noticeSrc = $($('#t-notification').html());
      _results = [];
      for (_i = 0, _len = notifications.length; _i < _len; _i++) {
        note = notifications[_i];
        $notice = $noticeSrc.clone();
        $notice.removeAttr('id');
        $.data($notice[0], 'info', {
          id: note.id
        });
        $notice.find('.senderAvatar').attr('src', note.avatar);
        $notice.find('.subject').html(note.subject);
        $notice.find('.noticeClose').click(function() {
          var noteID;
          noteID = $.data($(this).parent()[0], 'info').id;
          Materia.Coms.Json.send('notification_delete', [noteID]);
          $(this).parent().slideUp(function() {
            $(this).remove();
            $('#notifications_link').attr('data-notifications', $('#notices').children().length);
            checkForOverflow();
            if ($('#notices').children().length === 0) {
              $('#notices').remove();
              $('#notifications_link').removeClass('selected');
              return $('#notifications_link').hide();
            }
          });
          return false;
        });
        $('#notices').append($notice);
        _results.push($($notice).hide());
      }
      return _results;
    };
    return {
      init: init,
      checkForOverflow: checkForOverflow,
      getNotifications: getNotifications
    };
  })();

}).call(this);
